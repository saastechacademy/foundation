## Detail Design: Query Building with graphql-java

### Goal
Define how we will build GraphQL queries using graphql-java AST classes, starting with a simple orders query (last one hour, scalar fields only).

---

### Query 1: Orders Created in the Last Hour (Scalars Only)

#### GraphQL Intent (Human Readable)
We want:
- Orders created in the last one hour
- Only scalar/enum fields on `Order` (no nested objects)

Example GraphQL (for reference only):
```graphql
query OrdersLastHour($search: String!, $first: Int!, $after: String) {
  orders(query: $search, first: $first, after: $after, sortKey: CREATED_AT, reverse: true) {
    edges {
      node {
        id
        name
        createdAt
        cancelledAt
        closedAt
        currencyCode
        customerLocale
        email
        phone
        tags
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

#### graphql-java AST Design
We will construct the AST using the following classes:
- `Document`
- `OperationDefinition`
- `Field`
- `SelectionSet`
- `Argument`
- `Value` nodes (`StringValue`, `IntValue`, `BooleanValue`, `EnumValue`, `VariableReference`)

#### Variable Strategy
- `$search`: generated by the caller, e.g., `"created_at:>2024-05-10T10:30:00Z"`
- `$first`: page size for orders (e.g., 50)
- `$after`: cursor (nullable)

#### Selection Set Strategy
Use only scalar/enum fields from the Order type:
- `id`, `name`, `createdAt`, `cancelledAt`, `closedAt`
- `currencyCode`, `customerLocale`
- `email`, `phone`, `tags`

No nested objects:
- `customer`, `shippingAddress`, `lineItems`, etc. are excluded.

#### AST Construction Flow (Conceptual)
1) Build `Field orders` with arguments:
   - `query: $search`
   - `first: $first`
   - `after: $after`
   - `sortKey: CREATED_AT`
   - `reverse: true`
2) Add selection set to `orders`:
   - `edges -> node -> [scalar fields]`
   - `pageInfo -> hasNextPage, endCursor`
3) Wrap in `OperationDefinition` with variable definitions.
4) Wrap in `Document`.

#### Output
The facade returns:
- `Document` (or serialized query string)
- `variables` map with `search`, `first`, `after`

---

### Notes
- This design stays close to graphql-java (no custom selection DSL).
- We will validate the AST against the SDL before serialization.

---

### Helper: Build Scalar Selection Set from Schema
If we want the equivalent of a SQL-style `*` for scalars/enums, we can construct a `SelectionSet` by inspecting the schema.

```java
import graphql.language.Field;
import graphql.language.SelectionSet;
import graphql.schema.GraphQLFieldDefinition;
import graphql.schema.GraphQLObjectType;
import graphql.schema.GraphQLSchema;
import graphql.schema.GraphQLType;
import graphql.schema.GraphQLTypeUtil;

public class SelectionSetUtil {
    public static SelectionSet scalarSelectionSet(GraphQLSchema schema, String typeName) {
        GraphQLObjectType type = (GraphQLObjectType) schema.getType(typeName);
        if (type == null) {
            throw new IllegalArgumentException("Type not found in schema: " + typeName);
        }

        SelectionSet.Builder selection = SelectionSet.newSelectionSet();

        for (GraphQLFieldDefinition fieldDef : type.getFieldDefinitions()) {
            GraphQLType rawType = GraphQLTypeUtil.unwrapAll(fieldDef.getType());

            if (GraphQLTypeUtil.isScalar(rawType) || GraphQLTypeUtil.isEnum(rawType)) {
                selection.selection(Field.newField(fieldDef.getName()).build());
            }
        }

        return selection.build();
    }
}
```

This helper can be used for `Order`, `Product`, or any object type in the SDL.

---

### Java Example (graphql-java AST)
```java
import graphql.language.Argument;
import graphql.language.Document;
import graphql.language.EnumValue;
import graphql.language.Field;
import graphql.language.OperationDefinition;
import graphql.language.SelectionSet;
import graphql.language.VariableDefinition;
import graphql.language.VariableReference;
import graphql.language.TypeName;
import graphql.language.NonNullType;
import graphql.schema.GraphQLSchema;

// Assume schema is already loaded
GraphQLSchema schema = /* loaded schema */;

SelectionSet orderFields = SelectionSetUtil.scalarSelectionSet(schema, "Order");

SelectionSet ordersSelection = SelectionSet.newSelectionSet()
    .selection(Field.newField("edges")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("node")
                .selectionSet(orderFields)
                .build())
            .build())
        .build())
    .selection(Field.newField("pageInfo")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("hasNextPage").build())
            .selection(Field.newField("endCursor").build())
            .build())
        .build())
    .build();

Field ordersField = Field.newField("orders")
    .argument(Argument.newArgument("query", VariableReference.newVariableReference("search").build()).build())
    .argument(Argument.newArgument("first", VariableReference.newVariableReference("first").build()).build())
    .argument(Argument.newArgument("after", VariableReference.newVariableReference("after").build()).build())
    .argument(Argument.newArgument("sortKey", EnumValue.newEnumValue("CREATED_AT").build()).build())
    .argument(Argument.newArgument("reverse", graphql.language.BooleanValue.newBooleanValue(true).build()).build())
    .selectionSet(ordersSelection)
    .build();

OperationDefinition operation = OperationDefinition.newOperationDefinition()
    .name("OrdersLastHour")
    .operation(OperationDefinition.Operation.QUERY)
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("search")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("String").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("first")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("Int").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("after")
        .type(TypeName.newTypeName("String").build())
        .build())
    .selectionSet(SelectionSet.newSelectionSet().selection(ordersField).build())
    .build();

Document document = Document.newDocument().definition(operation).build();
```

---

### Query 2: Orders + Shipping and Billing Addresses

#### GraphQL Intent (Human Readable)
We want:
- Orders created in the last one hour
- Scalar fields on Order
- `shippingAddress` and `billingAddress` objects (from the schema)

Example GraphQL (for reference only):
```graphql
query OrdersWithAddresses($search: String!, $first: Int!, $after: String) {
  orders(query: $search, first: $first, after: $after, sortKey: CREATED_AT, reverse: true) {
    edges {
      node {
        id
        name
        createdAt
        shippingAddress {
          firstName
          lastName
          company
          address1
          address2
          city
          province
          country
          countryCode
          zip
          phone
        }
        billingAddress {
          firstName
          lastName
          company
          address1
          address2
          city
          province
          country
          countryCode
          zip
          phone
        }
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

#### Java Example (graphql-java AST)
```java
import graphql.language.Argument;
import graphql.language.Document;
import graphql.language.EnumValue;
import graphql.language.Field;
import graphql.language.OperationDefinition;
import graphql.language.SelectionSet;
import graphql.language.VariableDefinition;
import graphql.language.VariableReference;
import graphql.language.TypeName;
import graphql.language.NonNullType;
import graphql.schema.GraphQLSchema;

// Assume schema is already loaded
GraphQLSchema schema = /* loaded schema */;

SelectionSet addressFields = SelectionSetUtil.scalarSelectionSet(schema, "MailingAddress");

SelectionSet orderFieldsWithAddresses = SelectionSet.newSelectionSet()
    .selection(Field.newField("id").build())
    .selection(Field.newField("name").build())
    .selection(Field.newField("createdAt").build())
    .selection(Field.newField("shippingAddress")
        .selectionSet(addressFields)
        .build())
    .selection(Field.newField("billingAddress")
        .selectionSet(addressFields)
        .build())
    .build();

SelectionSet ordersSelection = SelectionSet.newSelectionSet()
    .selection(Field.newField("edges")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("node")
                .selectionSet(orderFieldsWithAddresses)
                .build())
            .build())
        .build())
    .selection(Field.newField("pageInfo")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("hasNextPage").build())
            .selection(Field.newField("endCursor").build())
            .build())
        .build())
    .build();

Field ordersField = Field.newField("orders")
    .argument(Argument.newArgument("query", VariableReference.newVariableReference("search").build()).build())
    .argument(Argument.newArgument("first", VariableReference.newVariableReference("first").build()).build())
    .argument(Argument.newArgument("after", VariableReference.newVariableReference("after").build()).build())
    .argument(Argument.newArgument("sortKey", EnumValue.newEnumValue("CREATED_AT").build()).build())
    .argument(Argument.newArgument("reverse", graphql.language.BooleanValue.newBooleanValue(true).build()).build())
    .selectionSet(ordersSelection)
    .build();

OperationDefinition operation = OperationDefinition.newOperationDefinition()
    .name("OrdersWithAddresses")
    .operation(OperationDefinition.Operation.QUERY)
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("search")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("String").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("first")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("Int").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("after")
        .type(TypeName.newTypeName("String").build())
        .build())
    .selectionSet(SelectionSet.newSelectionSet().selection(ordersField).build())
    .build();

Document document = Document.newDocument().definition(operation).build();
```
