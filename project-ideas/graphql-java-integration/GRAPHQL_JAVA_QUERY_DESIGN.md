## Detail Design: Query Building with graphql-java

### Goal
Define how we will build GraphQL queries using graphql-java AST classes, starting with a simple orders query (last one hour, scalar fields only).

### Scope
- Define the query-building approach using graphql-java AST (no custom model).
- Show concrete example queries the facade must support (orders last hour; with addresses).
- Document variable strategy and selection-set strategy (scalars vs nested objects).
- Outline the AST construction flow and expected outputs (Document + variables).
- Capture helper utilities needed (e.g., scalar selection from schema).
- Boundaries: no execution, no server, no codegen, no heavy custom DSL beyond thin syntax sugar.

---

### Query 1: Orders Created in the Last Hour (Scalars Only)

#### GraphQL Intent (Human Readable)
We want:
- Orders created in the last one hour
- Only scalar/enum fields on `Order` (no nested objects)

Example GraphQL (for reference only):
```graphql
query OrdersLastHour($search: String!, $first: Int!, $after: String) {
  orders(query: $search, first: $first, after: $after, sortKey: CREATED_AT, reverse: true) {
    edges {
      node {
        id
        name
        createdAt
        cancelledAt
        closedAt
        currencyCode
        customerLocale
        email
        phone
        tags
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

#### graphql-java AST Design
We will construct the AST using the following classes:
- `Document`
- `OperationDefinition`
- `Field`
- `SelectionSet`
- `Argument`
- `Value` nodes (`StringValue`, `IntValue`, `BooleanValue`, `EnumValue`, `VariableReference`)

#### Variable Strategy
- `$search`: generated by the caller, e.g., `"created_at:>2024-05-10T10:30:00Z"`
- `$first`: page size for orders (e.g., 50)
- `$after`: cursor (nullable)

#### Selection Set Strategy
Use only scalar/enum fields from the Order type:
- `id`, `name`, `createdAt`, `cancelledAt`, `closedAt`
- `currencyCode`, `customerLocale`
- `email`, `phone`, `tags`

No nested objects:
- `customer`, `shippingAddress`, `lineItems`, etc. are excluded.

#### AST Construction Flow (Conceptual)
1) Build `Field orders` with arguments:
   - `query: $search`
   - `first: $first`
   - `after: $after`
   - `sortKey: CREATED_AT`
   - `reverse: true`
2) Add selection set to `orders`:
   - `edges -> node -> [scalar fields]`
   - `pageInfo -> hasNextPage, endCursor`
3) Wrap in `OperationDefinition` with variable definitions.
4) Wrap in `Document`.

#### Output
The facade returns:
- `Document` (or serialized query string)
- `variables` map with `search`, `first`, `after`

#### Helper: Argument Builder (Moqui-style sugar)
In Moqui, arguments are often passed via fluent chaining. We can keep that ergonomic feel by building a list of `Argument` objects and applying them in bulk.

```java
import graphql.language.Argument;
import graphql.language.Field;
import graphql.language.Value;

import java.util.ArrayList;
import java.util.List;

public class ArgumentUtil {
    public static Argument arg(String name, Value<?> value) {
        return Argument.newArgument(name, value).build();
    }

    public static ArgumentBuilder builder() {
        return new ArgumentBuilder();
    }

    public static Field applyArguments(Field.Builder fieldBuilder, List<Argument> args) {
        for (Argument arg : args) {
            fieldBuilder.argument(arg);
        }
        return fieldBuilder.build();
    }
}

public class ArgumentBuilder {
    private final List<Argument> args = new ArrayList<>();

    public ArgumentBuilder arg(String name, Value<?> value) {
        args.add(ArgumentUtil.arg(name, value));
        return this;
    }

    public List<Argument> build() {
        return List.copyOf(args);
    }
}
```

Example usage:
```java
List<Argument> orderArgs = ArgumentUtil.builder()
    .arg("query", VariableReference.newVariableReference("search").build())
    .arg("first", VariableReference.newVariableReference("first").build())
    .arg("after", VariableReference.newVariableReference("after").build())
    .arg("sortKey", EnumValue.newEnumValue("CREATED_AT").build())
    .arg("reverse", graphql.language.BooleanValue.newBooleanValue(true).build())
    .build();

Field ordersField = ArgumentUtil.applyArguments(
    Field.newField("orders").selectionSet(ordersSelection),
    orderArgs
);
```

#### Helper: condition-style Query String Builder
To mirror Moquiâ€™s `condition(...)` and `conditionDate(...)`, we can provide a tiny helper that builds the Shopify `query` string, then pass it as the `query` argument.

```java
import java.time.Instant;
import java.util.ArrayList;
import java.util.List;

public class QueryStringBuilder {
    private final List<String> clauses = new ArrayList<>();

    public QueryStringBuilder condition(String field, String value) {
        clauses.add(field + ":" + value);
        return this;
    }

    public QueryStringBuilder conditionDate(String field, Instant greaterThan) {
        clauses.add(field + ":>" + greaterThan.toString());
        return this;
    }

    public String build() {
        return String.join(" ", clauses);
    }
}
```

Example usage:
```java
String search = new QueryStringBuilder()
    .condition("status", "ORDER_COMPLETED")
    .conditionDate("created_at", Instant.now().minusSeconds(3600))
    .build();
```

---

### Notes
- This design stays close to graphql-java (no custom selection DSL).
- We will validate the AST against the SDL before serialization.

---

### Helper: Build Scalar Selection Set from Schema
If we want the equivalent of a SQL-style `*` for scalars/enums, we can construct a `SelectionSet` by inspecting the schema.

```java
import graphql.language.Field;
import graphql.language.SelectionSet;
import graphql.schema.GraphQLFieldDefinition;
import graphql.schema.GraphQLObjectType;
import graphql.schema.GraphQLSchema;
import graphql.schema.GraphQLType;
import graphql.schema.GraphQLTypeUtil;

public class SelectionSetUtil {
    public static SelectionSet scalarSelectionSet(GraphQLSchema schema, String typeName) {
        GraphQLObjectType type = (GraphQLObjectType) schema.getType(typeName);
        if (type == null) {
            throw new IllegalArgumentException("Type not found in schema: " + typeName);
        }

        SelectionSet.Builder selection = SelectionSet.newSelectionSet();

        for (GraphQLFieldDefinition fieldDef : type.getFieldDefinitions()) {
            GraphQLType rawType = GraphQLTypeUtil.unwrapAll(fieldDef.getType());

            if (GraphQLTypeUtil.isScalar(rawType) || GraphQLTypeUtil.isEnum(rawType)) {
                selection.selection(Field.newField(fieldDef.getName()).build());
            }
        }

        return selection.build();
    }
}
```

This helper can be used for `Order`, `Product`, or any object type in the SDL.

---

### Java Example (graphql-java AST)
```java
import graphql.language.Argument;
import graphql.language.Document;
import graphql.language.EnumValue;
import graphql.language.Field;
import graphql.language.OperationDefinition;
import graphql.language.SelectionSet;
import graphql.language.VariableDefinition;
import graphql.language.VariableReference;
import graphql.language.TypeName;
import graphql.language.NonNullType;
import graphql.schema.GraphQLSchema;

// Assume schema is already loaded
GraphQLSchema schema = /* loaded schema */;

SelectionSet orderFields = SelectionSetUtil.scalarSelectionSet(schema, "Order");

SelectionSet ordersSelection = SelectionSet.newSelectionSet()
    .selection(Field.newField("edges")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("node")
                .selectionSet(orderFields)
                .build())
            .build())
        .build())
    .selection(Field.newField("pageInfo")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("hasNextPage").build())
            .selection(Field.newField("endCursor").build())
            .build())
        .build())
    .build();

List<Argument> orderArgs = ArgumentUtil.builder()
    .arg("query", VariableReference.newVariableReference("search").build())
    .arg("first", VariableReference.newVariableReference("first").build())
    .arg("after", VariableReference.newVariableReference("after").build())
    .arg("sortKey", EnumValue.newEnumValue("CREATED_AT").build())
    .arg("reverse", graphql.language.BooleanValue.newBooleanValue(true).build())
    .build();

Field ordersField = ArgumentUtil.applyArguments(
    Field.newField("orders").selectionSet(ordersSelection),
    orderArgs
);

OperationDefinition operation = OperationDefinition.newOperationDefinition()
    .name("OrdersLastHour")
    .operation(OperationDefinition.Operation.QUERY)
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("search")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("String").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("first")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("Int").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("after")
        .type(TypeName.newTypeName("String").build())
        .build())
    .selectionSet(SelectionSet.newSelectionSet().selection(ordersField).build())
    .build();

Document document = Document.newDocument().definition(operation).build();
```

---

### Query 2: Orders + Shipping and Billing Addresses

#### GraphQL Intent (Human Readable)
We want:
- Orders created in the last one hour
- Scalar fields on Order
- `shippingAddress` and `billingAddress` objects (from the schema)

Example GraphQL (for reference only):
```graphql
query OrdersWithAddresses($search: String!, $first: Int!, $after: String) {
  orders(query: $search, first: $first, after: $after, sortKey: CREATED_AT, reverse: true) {
    edges {
      node {
        id
        name
        createdAt
        shippingAddress {
          firstName
          lastName
          company
          address1
          address2
          city
          province
          country
          countryCode
          zip
          phone
        }
        billingAddress {
          firstName
          lastName
          company
          address1
          address2
          city
          province
          country
          countryCode
          zip
          phone
        }
      }
    }
    pageInfo {
      hasNextPage
      endCursor
    }
  }
}
```

#### Java Example (graphql-java AST)
```java
import graphql.language.Argument;
import graphql.language.Document;
import graphql.language.EnumValue;
import graphql.language.Field;
import graphql.language.OperationDefinition;
import graphql.language.SelectionSet;
import graphql.language.VariableDefinition;
import graphql.language.VariableReference;
import graphql.language.TypeName;
import graphql.language.NonNullType;
import graphql.schema.GraphQLSchema;

// Assume schema is already loaded
GraphQLSchema schema = /* loaded schema */;

SelectionSet addressFields = SelectionSetUtil.scalarSelectionSet(schema, "MailingAddress");
SelectionSet orderScalarFields = SelectionSetUtil.scalarSelectionSet(schema, "Order");

SelectionSet orderFieldsWithAddresses = SelectionSet.newSelectionSet(orderScalarFields)
    .selection(Field.newField("shippingAddress")
        .selectionSet(addressFields)
        .build())
    .selection(Field.newField("billingAddress")
        .selectionSet(addressFields)
        .build())
    .build();

SelectionSet ordersSelection = SelectionSet.newSelectionSet()
    .selection(Field.newField("edges")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("node")
                .selectionSet(orderFieldsWithAddresses)
                .build())
            .build())
        .build())
    .selection(Field.newField("pageInfo")
        .selectionSet(SelectionSet.newSelectionSet()
            .selection(Field.newField("hasNextPage").build())
            .selection(Field.newField("endCursor").build())
            .build())
        .build())
    .build();

List<Argument> orderArgs = ArgumentUtil.builder()
    .arg("query", VariableReference.newVariableReference("search").build())
    .arg("first", VariableReference.newVariableReference("first").build())
    .arg("after", VariableReference.newVariableReference("after").build())
    .arg("sortKey", EnumValue.newEnumValue("CREATED_AT").build())
    .arg("reverse", graphql.language.BooleanValue.newBooleanValue(true).build())
    .build();

Field ordersField = ArgumentUtil.applyArguments(
    Field.newField("orders").selectionSet(ordersSelection),
    orderArgs
);

OperationDefinition operation = OperationDefinition.newOperationDefinition()
    .name("OrdersWithAddresses")
    .operation(OperationDefinition.Operation.QUERY)
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("search")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("String").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("first")
        .type(NonNullType.newNonNullType(TypeName.newTypeName("Int").build()).build())
        .build())
    .variableDefinition(VariableDefinition.newVariableDefinition()
        .name("after")
        .type(TypeName.newTypeName("String").build())
        .build())
    .selectionSet(SelectionSet.newSelectionSet().selection(ordersField).build())
    .build();

Document document = Document.newDocument().definition(operation).build();
```
